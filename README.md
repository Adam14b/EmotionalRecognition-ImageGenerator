# Дизайн ML системы компьютерного зрения с возможностью генерации иллюстраций.
# АГРЕГАЦИЯ !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
> ## Термины и пояснения
> - ```"Dion"``` - корпоративный мессенджер для обмена сообщениями и проведения встреч в формате видеозвонка.
>
> - ИММО - Итерация по моделированию машинного обучения (ИММО). Состоит из шагов поиска данных, их обработки, подготовки к машинному обучению, само машинное обучение и анализ полученных результатов


### 1. Цели и предпосылки 
#### 1.1. Обоснованность разработки продукта 

##### Бизнес-цель:
- разработка системы компьютерного зрения для анализа мимики клиентов в видеоконференциях с целью выяснения какое 
  количество времени клиент был доволен разговором для дальнейшего повышения уровня обслуживания;
- генерация визуальных иллюстраций для более наглядной демонстрации доходности инвестиций клиентов.

 ##### Описание текущего бизнес-процесса: 
За каждым клиентом закреплен личный менеджер, сопровождающий клиента, в том числе через платформу "Dion".
Менеджеру необходимо самостоятельно составлять пояснительные иллюстрации для рекомендации каких-либо банковских продуктов, а так же анализировать качество диалога и удовлетворённость клиента, опираясь только на своё субъективное мнение. 

##### Почему станет лучше, чем сейчас, от использования ML:
- Для задачи отслеживания мимики:
  - Автоматизация анализа положительной и отрицательной мимики клиентов в реальном времени позволит менеджерам точнее           считывать клиентские эмоции во время разговора, что значительно повысит качество взаимодействия и повысит уровень           клиентоориентированности. 
- Для задачи генерации визуальных иллюстраций:
  - Автоматизированная генерация визуализаций продуктов в зависимости от данных клиента позволит демонстрировать адаптивные     иллюстрации, отражающие потенциальный рост их инвестиций, что повысит прозрачность предлагаемых услуг.
  
##### Что будем считать успехом итерации с точки зрения бизнеса: 
- положительный отзыв клиента о визуализации банковских продуктов;
- отчет в виде таблицы об удовлетворенности клиента после видеоконференции, основанный на отслеживании мимики клиента;
- интенсификация инвестиций клиентом в предлагаемые инвестиционные продукты.
  
#### 1.2. Бизнес-требования и ограничения  

##### Бизнес требования:
- отслеживание положительной и отрицательной мимики клиента во время диалога с персональным менеджером для дальнейшего        составления отчета об удовлетворенности клиента;
- генерация визуальных иллюстраций для клиента, для более наглядной демонстрации перспективы рассматриваемого продукта.
  
##### Бизнес ограничения:
- cистема компьютерного зрения должна работать в реальном времени во время видеоконференции;
- система должна присылать отчет-таблицу сразу после окончания видеоконференции;
- данные клиентов должны обрабатываться в соответствии с общим регламентом по защите данных (GDPR) и другими законами о     
  защите данных.

##### Что мы ожидаем от первой иттерации:
- система поддерживает автономную работу каждого элемента по отдельности,!!! без интеграции на платформу "Dion"!!!!;
- отдельные алгоритмы системы должны показывать часть своего функционала и возможностей;
- каждый элемент системы может быть развернут и протестирован на рабочем компьютере как сотрудника, так и проверяющего работу сотрудника руководителя;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
- система готова к дальнейшему масштабированию и последующим иттерациям.

##### Проведение пилота:
- Тестирование модели может проводиться на небольшой выборке реальных клиентов (10-20 человек), которые были уведомлены о предстоящем тестировании модели (опционально, при согласовании с юридическим отделом), а так же дали свое согласие на обработку персональных данных. В этом случае необходимор организовать видеоконференции с выбранными для тестирования клиентами, во время которых менеджер будет использовать программу для отслеживания мимики и последующей классификацией эмоций, с дальнейшей агрегацией и вычислением степени удовлетворенности видеоконференцией.
Для тестирования программы генерации пояснительных иллюстраций дополнительного согласия на обработку персональных данных не требуется, достаточно уведомить клиента о проведении тестирования.
Подразумевается, что клиенты будут давать обратную связь по завершению видеоконференции. Сравнив вывод модели классификации эмоций (отчет-таблица) ["пример вывода"](https://github.com/Adam14b/EmotionalRecognition-ImageGenerator/blob/main/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202024-07-04%20%D0%B2%2002.36.47.png) и отзыв клиента, мы можем сделать вывод о достоверности информации, полученной из модели.
Анализ качества программы для генерации пояснительных иллюстраций основывается, исключительно, на отзыве клиента и менеджера компании.

- в случае невозможности проведения тестирования на реальных клиентах, предлагаются два альтернативных варианта проведения тестирования:
    - проводить тестирование на работниках компании: после уведомления работников компании о проведении тестирования, систему необходимо интегрировать во внутреннюю программу видеоконференций. Затем необходимо получить обратную связь от работников компании (эмоции, полученные от проведенной видеоконференции)!!!!!!!!!!!!!!!!!!!!. Сравнив [вывод модели](https://github.com/Adam14b/EmotionalRecognition-ImageGenerator/blob/main/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202024-07-04%20%D0%B2%2002.36.47.png) классификации эмоций и отзывы работников о видеоконференции, можно сделать вывод о качестве данных, которые выводит модель, с поправкой на человеческий фактор.!!!!!!!!!!!!!!
  - проводить "синтетические" тесты, используя заранее маркированный видеоматериал. Выводы модели будут сравниваться с маркировкой видеоматериала.

    
  
##### Критерии успеха:
- Модель классификации и агрегации эмоций:
  	- Так как нужно избежать негативных эмоций от видеоконференции, именно предсказывание негативных эмоций и будет являться основной задачей модели, поэтому важно учитывать 	количество ложно положительных и ложно отрицательных предсказаний. В связи с вышеуказанными факторами и дисбалансом классов, была выбрана метрика ```F1-score```, 		умноженная на 100 для более явного представления в процентах.
  	
	- $$\text{F1-score}_{Negative} \cdot 100 \ge 80 \text{\\%, где:}$$
	> - $$\text{F1-score} = \frac{2 \cdot Presicion \cdot Recall}{Presicion + Recall}$$
	> - $$Precision = \frac{TruePositive}{TruePositive + FalsePositive}$$
	> - $$Recall = \frac{TruePositive}{TruePositive + FalseNegative}$$
	> - $$TruePositive \text{ - количество верно предсказанных значений положительного класса} $$
	> - $$FalsePositive \text{ - количество неверно предсказанных значений положительного класса}$$
  	> - $$FalseNegative \text{ - количество неверно предсказанных значений отрицательного класса}. $$
	
#### 1.3. Что входит в первую иттерации, что не входит: 
##### что входит:
- разработка модели классификации и агрегации эмоций;
- подгтовка и проведение пилота;
- интеграция системы на платформу "Dion";

###### что не входит:
- полная интеграция с другими корпоративными системами;
- оптимизация модели для мобильных устройств;
- реализация маркетинговой системы для продвижения проекта;

##### описание планируемого технического долга (что оставляем для дальнейшей продуктивизации):
- добавить распознование лиц каждого клиента, для последующей отчетности и отслеживания изменений степени удовлетворенности от видеоконференций;
- разработка модели генерации пояснительных иллюстраций, совместно с DS-отделом;


- На закрытие каких БТ подписываемся в данной итерации `Data Scientist`   
- Что не будет закрыто `Data Scientist`  
- Описание результата с точки зрения качества кода и воспроизводимости решения `Data Scientist`  
- Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации) `Data Scientist`  

#### 1.4. Предпосылки решения  

- Описание всех общих предпосылок решения, используемых в системе – с обоснованием от запроса бизнеса: какие блоки данных используем, горизонт прогноза, гранулярность модели, и др. `Data Scientist`  

### 2. Методология `Data Scientist`     

#### 2.1. Постановка задачи  

- Что делаем с технической точки зрения: рекомендательная система, поиск аномалий, прогноз, оптимизация, и др. `Data Scientist`  

#### 2.2. Блок-схема решения  

- Блок-схема для бейзлайна и основного MVP с ключевыми этапами решения задачи: подготовка данных, построение прогнозных моделей, оптимизация, тестирование, закрытие технического долга, подготовка пилота, другое. `Data Scientist`  
- [Пример возможной блок схемы](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/product_schema.png?raw=true)
> Схема обязательно включает в себя архитектуру бейзлайна. Если бейзлайн и основной MVP отличаются несущественно, то это может быть одна блок-схема. Если значительно, то рисуем две: отдельно для бейзлайна, отдельно для основного MVP.  
> Если блок-схема **шаблонна** - т.е. её можно скопировать и применить к разным продуктам, то она **некорректна**. Блок-схема должна показывать схему решения для конкретной задачи, поставленной в части 1.    

#### 2.3. Этапы решения задачи `Data Scientist`  

- Для каждого этапа **по результатам EDA** описываем - **отдельно для бейзлайна** и **отдельно для основного MVP** - все про данные и технику решения максимально конкретно. Обозначаем необходимые вводные, технику предполагаемого решения и что ожидаем получить на выходе, чтобы перейти к следующему этапу.  
- Как правило, детальное и структурированное заполнение раздела `2.3` возможно только **по результатам EDA**.  
- Если описание в дизайн доке **шаблонно** - т.е. его можно скопировать и применить к разным продуктам, то оно **некорректно**. Дизайн док должен показывать схему решения для конкретной задачи, поставленной в части 1.  
    
> Примеры этапов:  
> - Этап 2 - Подготовка прогнозных моделей  
> - Этап 3 - Интерпретация моделей (согл. с заказчиком)  
> - Этап 4 - Интеграция бизнес правил для расчета бизнес-метрик качества мрдели  
> - Этап 5 - Подготовка инференса модели по итерациям    
> - Этап 6 - Интеграция бизнес правил  
> - Этап 7 - Разработка оптимизатора (выбор оптимальной итерации)  
> - Этап 8 - Подготовка финального отчета для бизнеса  

*Этап 1 - это обычно, подготовка данных.*  

В этом этапе должно быть следующее:  

- Данные и сущности, на которых будет обучаться ваша модель машинного обучения. Отдельная таблица для целевой переменной (либо целевых переменных разных этапов), отдельная таблица – для признаков.  
  
| Название данных  | Есть ли данные в компании (если да, название источника/витрин) | Требуемый ресурс для получения данных (какие роли нужны) | Проверено ли качество данных (да, нет) |
| ------------- | ------------- | ------------- | ------------- |
| Продажи | DATAMARTS_SALES_PER_DAY  | DE/DS | + |
| ...  | ...  | ... | ... |
 
- Краткое описание результата этапа - что должно быть на выходе: витрины данных, потоки данных, др.  
  
> Чаще всего заполнение раздела невозможно без EDA.

 *Этапы 2 и далее, помимо подготовки данных.*
 
Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:  

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`    
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`   
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`   
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`   
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`    
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`    
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).  
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`  
  
### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  
  
- Краткое описание предполагаемого дизайна и способа оценки пилота `Product Owner`, `Data Scientist` with `AB Group` 
  
#### 3.2. Что считаем успешным пилотом  
  
Формализованные в пилоте метрики оценки успешности `Product Owner`   
  
#### 3.3. Подготовка пилота  
  
- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist` 

### 4. Внедрение `для production систем, если требуется`    

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.  
  
#### 4.1. Архитектура решения   
  
- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- Какая инфраструктура выбрана и почему `Data Scientist` 
- Плюсы и минусы выбора `Data Scientist` 
- Почему финальный выбор лучше других альтернатив `Data Scientist` 
  
#### 4.3. Требования к работе системы  
  
- SLA, пропускная способность и задержка `Data Scientist`  
  
#### 4.4. Безопасность системы  
  
- Потенциальная уязвимость системы `Data Scientist`  
  
#### 4.5. Безопасность данных   
  
- Нет ли нарушений GDPR и других законов `Data Scientist`  
  
#### 4.6. Издержки  
  
- Расчетные издержки на работу системы в месяц `Data Scientist`  
  
#### 4.5. Integration points  
  
- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`  
  
#### 4.6. Риски  
  
- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`   
  
> ### Материалы для дополнительного погружения в тему  
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела  
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews  
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен  
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.
> 
